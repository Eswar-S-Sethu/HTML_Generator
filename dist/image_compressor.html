<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Image Compressor | ToolStack</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #0B0C1D;
      color: white;
    }
    .navbar-light {
      background-color: #121317 !important;
    }
    .navbar-light .navbar-brand {
      color: #f1f1f1;
    }
    .custom-navbar {
      padding-top: 1.5rem;
      padding-bottom: 1.5rem;
      min-height: 80px;
    }
    .custom-navbar .navbar-brand {
      font-size: 1.6rem;
    }
    .custom-navbar input.form-control {
      height: 48px;
      font-size: 1rem;
    }
    .drop-zone {
      border: 2px dashed #6c757d;
      border-radius: 10px;
      padding: 40px;
      text-align: center;
      transition: background-color 0.3s ease;
    }
    .drop-zone.dragover {
      background-color: rgba(108, 117, 125, 0.1);
    }
    .preview-img {
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
    }
    .slider-label {
      font-size: 1rem;
    }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light custom-navbar border-bottom mb-5">
  <div class="container d-flex justify-content-between align-items-center">
    <a class="navbar-brand fw-bold me-auto" href="index.html">ToolStack</a>
  </div>
</nav>
<div class="container py-5">
  <h1 class="text-center mb-4">Image Compressor</h1>

  <!-- Drag and Drop Zone -->
  <div class="drop-zone mb-4" id="dropZone">
    <p>Drag and drop a PNG, JPG, or WebP image here</p>
    <p class="text-secondary small">(Only one image at a time)</p>
    <input type="file" accept="image/png, image/jpeg, image/webp" id="fileInput" hidden>
    <button class="btn btn-outline-light mt-3" onclick="document.getElementById('fileInput').click()">Select Image</button>
  </div>

  <!-- Format Conversion -->
  <div class="row mb-4">
    <div class="col-md-6">
      <label for="formatSelect" class="form-label">Convert Format</label>
      <select id="formatSelect" class="form-select">
        <option value="original">Keep Original</option>
        <option value="jpg">Convert to JPG</option>
        <option value="png">Convert to PNG</option>
      </select>
    </div>
    <div class="col-md-6">
      <label for="compressionSlider" class="form-label">Compression Level: <span id="compressionValue">80%</span></label>
      <input type="range" class="form-range" min="10" max="100" value="80" id="compressionSlider">
    </div>
  </div>

  <!-- Preview Section -->
  <div class="row g-4 text-center">
    <div class="col-md-6">
      <h5>Original</h5>
      <img id="originalPreview" class="preview-img" src="#" alt="Original Preview" hidden>
    </div>
    <div class="col-md-6">
      <h5>Compressed</h5>
      <img id="compressedPreview" class="preview-img" src="#" alt="Compressed Preview" hidden>
    </div>
  </div>

  <!-- Download Button -->
  <div class="text-center mt-4">
    <button class="btn btn-success btn-lg px-4" id="downloadBtn" disabled>Download Compressed Image</button>
  </div>
</div>

<!-- Footer -->
  <footer class="bg-dark text-light pt-4 mt-0">
  <div class="container">
    <div class="row text-center text-md-start">
      <!-- About -->
      <div class="col-md-4 mb-3">
        <h5 class="fw-bold">ToolStack</h5>
        <p class="small">Serverless by Design. No Fluff. No BS. Built for real users, by an indie dev, using Rust and WebAssembly.</p>
      </div>

      <!-- Useful Links -->
      <div class="col-md-4 mb-3">
        <h6 class="fw-bold">Useful Links</h6>
        <ul class="list-unstyled">
          <li><a href="index.html" class="text-light text-decoration-none">Home</a></li>
          <li><a href="privacy_policy.html" class="text-light text-decoration-none">Privacy Policy</a></li>
          <li><a href="terms_of_use.html" class="text-light text-decoration-none">Terms of Use</a></li>
          <li><a href="contact_developer.html" class="text-light text-decoration-none">About Developer</a></li>
        </ul>
      </div>

      <!-- Social / Extras -->
      <div class="col-md-4 mb-3">
        <h6 class="fw-bold">Connect</h6>
        <ul class="list-unstyled">
          <li><a href="https://x.com/eswar_sethu" class="text-light text-decoration-none">X</a></li>
          <li><a href="https://github.com/Eswar-S-Sethu" class="text-light text-decoration-none">Github</a></li>
          <li><a href="mailto:dev@toolstack.com.au" class="text-light text-decoration-none">Email</a></li>
        </ul>
      </div>
    </div>

    <hr class="bg-secondary" />

    <div class="text-center small pb-3">
      &copy; 2025 <strong>ToolStack</strong>. Born in Melbourne. Built for the world. All rights reserved.
    </div>
  </div>
</footer>
<script>
  const dropZone = document.getElementById("dropZone");
  const fileInput = document.getElementById("fileInput");
  const compressionSlider = document.getElementById("compressionSlider");
  const compressionValue = document.getElementById("compressionValue");

  compressionSlider.addEventListener("input", () => {
    compressionValue.textContent = `${compressionSlider.value}%`;
  });

  dropZone.addEventListener("dragover", e => {
    e.preventDefault();
    dropZone.classList.add("dragover");
  });

  dropZone.addEventListener("dragleave", () => {
    dropZone.classList.remove("dragover");
  });

  dropZone.addEventListener("drop", e => {
    e.preventDefault();
    dropZone.classList.remove("dragover");
    if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
  });

  fileInput.addEventListener("change", () => {
    if (fileInput.files.length) handleFile(fileInput.files[0]);
  });

  function handleFile(file) {
    const validTypes = ["image/png", "image/jpeg", "image/webp"];
    if (!validTypes.includes(file.type)) return alert("Unsupported file type.");

    const reader = new FileReader();
    reader.onload = () => {
      document.getElementById("originalPreview").src = reader.result;
      document.getElementById("originalPreview").hidden = false;
      // Prepare the buffer to send to Rust backend
      window.imageBuffer = reader.result;
      // Placeholder for preview update after compression
      document.getElementById("compressedPreview").src = reader.result;
      document.getElementById("compressedPreview").hidden = false;
      document.getElementById("downloadBtn").disabled = false;
    };
    reader.readAsDataURL(file);
  }
</script>
<script type="module">
  import init, { compress_image } from './UnitConverter.js';

  let originalStats = null;
  let compressedStats = null;
  let compressedBlob = null;
  let lastFormat=null;

  async function loadWasm() {
    await init(); // initialize WASM module
  }

  loadWasm();

  const compressionSlider = document.getElementById("compressionSlider");
  const formatSelect = document.getElementById("formatSelect");

  compressionSlider.addEventListener("input", () => {
    compressionValue.textContent = `${compressionSlider.value}%`;
    if (window.imageBuffer) runCompression();
  });

  formatSelect.addEventListener("change", () => {
    if (window.imageBuffer) runCompression();
  });

  async function runCompression() {
    const quality = parseInt(compressionSlider.value);
    const format = formatSelect.value;
    const input = window.imageBuffer;

    const result = await compress_image(input, quality, format);

    compressedBlob = new Blob([result.bytes], { type: `image/${result.format.toLowerCase()}` });
    const previewUrl = URL.createObjectURL(compressedBlob);

    document.getElementById("compressedPreview").src = previewUrl;
    document.getElementById("compressedPreview").hidden = false;
    document.getElementById("downloadBtn").disabled = false;

    compressedStats.textContent = `${result.size_kb.toFixed(2)} KB, ${result.width}x${result.height}, ${result.format}`;
    lastFormat=result.format;
  }

  document.getElementById("downloadBtn").addEventListener("click", () => {
  if (!compressedBlob) return;

  const extension = lastFormat.toLowerCase(); // jpg or png
  const mime = `image/${extension}`;

  const blobUrl = URL.createObjectURL(new Blob([compressedBlob], { type: mime }));

  const a = document.createElement('a');
  a.href = blobUrl;
  a.download = `compressed_image.${extension}`;
  document.body.appendChild(a); // necessary for Firefox
  a.click();
  document.body.removeChild(a); // cleanup
  URL.revokeObjectURL(blobUrl); // cleanup
});

  // Extend handleFile:
  window.handleFile = function(file) {
    const validTypes = ["image/png", "image/jpeg", "image/webp"];
    if (!validTypes.includes(file.type)) return alert("Unsupported file type.");

    const reader = new FileReader();
    reader.onload = () => {
      const img = new Image();
      img.onload = () => {
        document.getElementById("originalPreview").src = reader.result;
        document.getElementById("originalPreview").hidden = false;
        originalStats.textContent = `${(file.size / 1024).toFixed(2)} KB, ${img.width}x${img.height}, ${file.type.split("/")[1].toUpperCase()}`;
        window.imageBuffer = reader.result;
        runCompression();
      };
      img.src = reader.result;
    };
    reader.readAsDataURL(file);
  };

  // Inject placeholders for stats
  window.addEventListener('DOMContentLoaded', () => {
    originalStats = document.createElement('div');
    compressedStats = document.createElement('div');
    originalStats.className = "text-muted small mt-2";
    compressedStats.className = "text-muted small mt-2";

    document.getElementById("originalPreview").after(originalStats);
    document.getElementById("compressedPreview").after(compressedStats);
  });
</script>
</body>
</html>
